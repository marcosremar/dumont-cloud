# =============================================================================
# DUMONTCLOUD WORKER - Imagem otimizada para failover rápido
# =============================================================================
# Esta imagem é otimizada para download paralelo (múltiplas layers)
# Use com: docker pull --max-concurrent-downloads=10
# =============================================================================

FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

LABEL maintainer="DumontCloud"
LABEL description="GPU Worker com Ollama, B2 SDK e SSH pré-instalados"
LABEL version="1.0"

ENV DEBIAN_FRONTEND=noninteractive
ENV OLLAMA_MODELS=/workspace/ollama_models

# -----------------------------------------------------------------------------
# Layer 1: Ferramentas básicas de sistema
# -----------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Layer 2: Python e pip
# -----------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Layer 3: SSH Server (necessário para Vast.ai)
# -----------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir -p /var/run/sshd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# -----------------------------------------------------------------------------
# Layer 4: Ferramentas de desenvolvimento (git, nano, etc)
# -----------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    nano \
    htop \
    tmux \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Layer 5: Dependências Python para snapshots (B2 SDK + compressão)
# -----------------------------------------------------------------------------
RUN pip3 install --no-cache-dir \
    b2sdk \
    lz4 \
    requests

# -----------------------------------------------------------------------------
# Layer 6: Ollama (binário pré-instalado para inferência)
# -----------------------------------------------------------------------------
RUN curl -fsSL https://ollama.com/install.sh | sh

# -----------------------------------------------------------------------------
# Layer 7: Criar diretórios de trabalho
# -----------------------------------------------------------------------------
RUN mkdir -p /workspace/ollama_models \
    && mkdir -p /workspace/data \
    && mkdir -p /workspace/snapshots

# -----------------------------------------------------------------------------
# Configuração final
# -----------------------------------------------------------------------------
WORKDIR /workspace

# Expor portas: SSH (22) e Ollama API (11434)
EXPOSE 22 11434

# Script de entrada que inicia SSH e Ollama
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Comando padrão
CMD ["/entrypoint.sh"]
