# Whisper Server for Speech-to-Text
# Image: dumontcloud/whisper:4.40-cuda12.1
#
# Build:
#   docker build -f Dockerfile.whisper -t dumontcloud/whisper:4.40-cuda12.1 .
#
# Run:
#   docker run --gpus all -e MODEL_ID="openai/whisper-large-v3" -p 8001:8001 dumontcloud/whisper:4.40-cuda12.1

FROM pytorch/pytorch:2.1.2-cuda12.1-cudnn8-runtime

WORKDIR /app

# Fixed versions - tested and compatible
RUN pip install --no-cache-dir \
    transformers==4.40.2 \
    accelerate==0.31.0 \
    librosa==0.10.2 \
    soundfile==0.12.1 \
    fastapi==0.111.0 \
    uvicorn==0.30.1 \
    python-multipart==0.0.9

# Copy server
COPY servers/whisper_server.py /app/whisper_server.py

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:${PORT:-8001}/health || exit 1

EXPOSE 8001
ENV PORT=8001
ENV MODEL_ID="openai/whisper-large-v3"

CMD ["python", "/app/whisper_server.py"]
