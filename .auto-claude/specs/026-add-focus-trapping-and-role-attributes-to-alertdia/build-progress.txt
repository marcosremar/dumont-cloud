# Build Progress: Add focus trapping and role attributes to AlertDialog modal components

## Overview
Implementing proper focus management for modal components to comply with WCAG 2.4.3 Focus Order.

## Analysis Summary (2026-01-01)

### Components Identified

**Already Accessible (Radix-based - No changes needed):**
- `web/src/components/ui/alert-dialog.jsx` - Uses @radix-ui/react-alert-dialog (built-in focus trap)
- `web/src/components/ui/dialog.jsx` - Uses @radix-ui/react-dialog (built-in focus trap)

**Need Accessibility Improvements (Custom implementations):**
1. `web/src/components/tailadmin-ui/index.jsx` - AlertDialog (lines 667-729)
   - Custom implementation using createPortal
   - Missing: role, aria-modal, focus trapping, focus return
   - Used by: MachineCard, FailoverMigrationModal, CreateServerlessModal

2. `web/src/components/tailadmin/ui/modal/index.tsx` - Modal component
   - Custom implementation
   - Has Escape key handling (good)
   - Missing: role, aria-modal, focus trapping, focus return
   - Used by: Various pages

### Files Using tailadmin-ui AlertDialog:
- web/src/components/machines/MachineCard.jsx
- web/src/components/serverless/CreateServerlessModal.jsx
- web/src/components/FailoverMigrationModal.jsx

### Files Using tailadmin Modal:
- Multiple modal components in the codebase

## Implementation Plan

### Phase 1: Create useFocusTrap Hook
- Create reusable hook for focus management
- Handle Tab/Shift+Tab cycling
- Store and restore focus on mount/unmount

### Phase 2: Update tailadmin-ui AlertDialog
- Add role="alertdialog" and aria-modal="true"
- Integrate useFocusTrap hook
- Add aria-labelledby/aria-describedby support
- Ensure Escape key handling

### Phase 3: Update tailadmin Modal
- Add role="dialog" and aria-modal="true"
- Integrate useFocusTrap hook
- Verify Escape key behavior

### Phase 4: Testing
- Unit tests for useFocusTrap
- E2E accessibility tests
- Manual screen reader testing
- Regression testing

## Progress Log

[2026-01-01] Created implementation plan with 4 phases and 15 subtasks
[2026-01-01] Analyzed codebase - identified 2 custom modal components needing updates
[2026-01-01] Phase 1: Created useFocusTrap hook with focus trapping, Tab cycling, and focus restoration
[2026-01-01] Phase 2: Updated AlertDialog with ARIA attributes and useFocusTrap integration
[2026-01-01] Phase 3.1-3.2: Updated Modal with ARIA attributes and useFocusTrap integration
[2026-01-01] Phase 3.3: Verified Escape key handler integration with focus trap

## Subtask 3.3 Verification Results

### Escape Key Handler Verification

**Modal Component (`tailadmin/ui/modal/index.tsx`):**
- Escape key handler (lines 32-46) properly calls `onClose()` when Escape is pressed
- Event listener is properly cleaned up on unmount/when isOpen changes
- Focus trap (`useFocusTrap`) is called before Escape handler effect
- Focus trap stores `previouslyFocusedRef.current` when modal opens
- On cleanup, focus is properly returned to the trigger element

**AlertDialogContent (`tailadmin-ui/index.jsx`, lines 695-735):**
- Escape key handler (lines 707-718) properly calls `onOpenChange?.(false)`
- `event.preventDefault()` prevents event bubbling
- Event listener is properly cleaned up
- Focus trap properly stores and returns focus

### Flow Verification
1. Escape is pressed → handler calls `onClose()`/`onOpenChange(false)`
2. Parent updates state → `isOpen`/`open` becomes false
3. React re-runs effects due to dependency change
4. `useFocusTrap` cleanup runs → returns focus to previously focused element
5. Component unmounts/returns null

### No Conflicts Verified
- Escape handler only handles `Escape` key
- useFocusTrap only handles `Tab` key
- Each effect manages its own event listener with proper cleanup
- No duplicate event handlers

## Subtask 4.1 - Unit Tests for useFocusTrap Hook

### Files Created
- `web/vitest.config.ts` - Vitest configuration with jsdom environment
- `web/src/test/setup.ts` - Test setup file with jest-dom matchers
- `web/src/hooks/useFocusTrap.test.tsx` - Comprehensive unit tests

### Test Coverage
The test suite covers all acceptance criteria:

1. **Focus on Activation**
   - Moves focus to first focusable element when activated
   - Focuses container when no focusable elements exist
   - Does not move focus when isActive is false

2. **Tab Key Cycling**
   - Cycles forward through focusable elements with Tab
   - Wraps focus from last to first element with Tab

3. **Shift+Tab Cycling**
   - Cycles backward through focusable elements with Shift+Tab
   - Wraps focus from first to last element with Shift+Tab

4. **Focus Restoration**
   - Returns focus to previously focused element when deactivated

5. **Edge Cases**
   - Skips disabled buttons and inputs
   - Handles all types of focusable elements (button, input, select, textarea, a[href], [tabindex])
   - Excludes elements with tabindex=-1
   - Prevents focus from leaving container when focus is outside
   - Handles single focusable element correctly

6. **FOCUSABLE_SELECTOR Constant**
   - Tests all selector components

### Dependencies Added to package.json
- vitest: ^2.1.8
- jsdom: ^25.0.1
- @testing-library/react: ^16.1.0
- @testing-library/dom: ^10.4.0
- @testing-library/user-event: ^14.5.2
- @testing-library/jest-dom: ^6.6.3

### New npm Scripts
- `npm test` - Run vitest in watch mode
- `npm run test:run` - Run tests once
- `npm run test:coverage` - Run tests with coverage

### Running Tests
After installing dependencies (`npm install`), run:
```bash
cd web
npm run test:run
```
