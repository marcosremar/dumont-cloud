{
  "feature": "Multi-Currency Pricing System",
  "workflow_type": "feature",
  "workflow_rationale": "This is a new feature adding multi-currency support (not a bug fix or refactor). It requires new database models, API endpoints, scheduled tasks, and frontend components following the standard FEATURE workflow pattern.",
  "phases": [
    {
      "id": "phase-1-database-models",
      "name": "Database Models",
      "type": "implementation",
      "description": "Create SQLAlchemy models for exchange rates and user currency preferences",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create ExchangeRate and UserCurrencyPreference models",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/models/currency.py"
          ],
          "patterns_from": [
            "src/models/machine_history.py",
            "src/models/price_history.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd src && python -c \"from models.currency import ExchangeRate, UserCurrencyPreference; print('Models imported successfully')\"",
            "expected": "Models imported successfully"
          },
          "status": "completed",
          "notes": "Created ExchangeRate and UserCurrencyPreference models in src/models/currency.py. Models include: ExchangeRate with from_currency, to_currency, rate (Numeric 18,6), fetched_at columns and indexes for efficient lookups. UserCurrencyPreference with user_email, currency_code, created_at, updated_at columns. Both models include to_dict() and __repr__ methods following existing patterns. Updated models/__init__.py to export the new models. Verification passed successfully.",
          "updated_at": "2025-12-31T21:42:19.897480+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Create database migration for currency tables",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/migrations/add_currency_tables.py"
          ],
          "patterns_from": [
            "src/migrations/"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Run migration and verify tables exist: psql -c '\\dt exchange_rates' and \\dt user_currency_preferences'"
          },
          "status": "completed",
          "notes": "Created database migration script (src/migrations/add_currency_tables.py) that creates exchange_rates and user_currency_preferences tables with proper PostgreSQL schema. Migration includes: exchange_rates table with id, from_currency, to_currency, rate (NUMERIC 18,6), fetched_at columns plus indexes (idx_latest_rate, idx_exchange_rate_fetched). user_currency_preferences table with id, user_email (unique), currency_code, created_at, updated_at columns plus idx_user_currency_email index. Script follows existing migration patterns and includes idempotent checks. Run with: python -m src.migrations.add_currency_tables",
          "updated_at": "2025-12-31T21:46:01.543682+00:00"
        }
      ]
    },
    {
      "id": "phase-2-exchange-rate-service",
      "name": "Exchange Rate Service",
      "type": "implementation",
      "description": "Build service to fetch exchange rates from external API with Redis caching and fallback logic",
      "depends_on": [
        "phase-1-database-models"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create exchange rate fetching service",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/services/exchange_rate.py"
          ],
          "patterns_from": [
            "src/services/"
          ],
          "verification": {
            "type": "command",
            "command": "cd src && python -c \"from services.exchange_rate import ExchangeRateService; print('Service imported successfully')\"",
            "expected": "Service imported successfully"
          },
          "status": "completed",
          "notes": "Created ExchangeRateService in src/services/exchange_rate.py. Features include: async fetch_latest_rates() with httpx to fetch from external API, get_rate(from, to) for currency pair lookup, convert_amount(amount, from, to) with banker's rounding, get_all_rates() for all current rates, check_rates_health() for monitoring. Implements graceful fallback to cached database rates on API failure. Uses exponential backoff for retries. Supports USD, EUR, GBP, BRL currencies. Verification passed successfully.",
          "updated_at": "2025-12-31T21:51:13.272504+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Add environment variables for exchange rate API",
          "service": "backend",
          "files_to_modify": [
            ".env"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -q 'EXCHANGE_RATE_API_KEY' .env && grep -q 'EXCHANGE_RATE_API_URL' .env && echo 'OK' || echo 'MISSING'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added EXCHANGE_RATE_API_KEY and EXCHANGE_RATE_API_URL environment variables to both .env (local, gitignored) and .env.demo (template for version control). Verification passed successfully.",
          "updated_at": "2025-12-31T21:54:57.728313+00:00"
        }
      ]
    },
    {
      "id": "phase-3-scheduler",
      "name": "Scheduler Setup",
      "type": "implementation",
      "description": "Setup APScheduler for daily exchange rate updates at midnight UTC",
      "depends_on": [
        "phase-2-exchange-rate-service"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create scheduler module with APScheduler",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/core/scheduler.py"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd src && python -c \"from core.scheduler import init_scheduler; print('Scheduler imported successfully')\"",
            "expected": "Scheduler imported successfully"
          },
          "status": "completed",
          "notes": "Created scheduler module at src/core/scheduler.py with APScheduler. Features include: AsyncIOScheduler with UTC timezone, daily CronTrigger at midnight (00:00 UTC), update_exchange_rates_job() that calls ExchangeRateService.fetch_latest_rates(), init_scheduler() with optional immediate rate fetch on startup, shutdown_scheduler() for graceful cleanup, get_scheduler_status() for monitoring, add_custom_job() for additional scheduled tasks. Added APScheduler>=3.10.0 to requirements.txt. Verification passed successfully.",
          "updated_at": "2025-12-31T21:58:50.164776+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Integrate scheduler with FastAPI lifespan",
          "service": "backend",
          "files_to_modify": [
            "src/main.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/main.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'init_scheduler' src/main.py && echo 'OK' || echo 'MISSING'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Integrated scheduler with FastAPI lifespan. Added init_scheduler() call in startup section (after PeriodicSnapshotService, before final log). Added shutdown_scheduler() call in shutdown section (after AutoHibernationManager). Uses run_immediately=False to avoid blocking startup. Both init and shutdown wrapped in try/except for graceful error handling. Verification passed: grep confirms init_scheduler in main.py.",
          "updated_at": "2025-12-31T22:01:56.966353+00:00"
        }
      ]
    },
    {
      "id": "phase-4-api-endpoints",
      "name": "Backend API Endpoints",
      "type": "implementation",
      "description": "Create FastAPI endpoints for currency selection and pricing conversion",
      "depends_on": [
        "phase-2-exchange-rate-service"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create Pydantic schemas for currency requests/responses",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/api/v1/schemas/currency.py"
          ],
          "patterns_from": [
            "src/api/v1/schemas/"
          ],
          "verification": {
            "type": "command",
            "command": "cd src && python -c \"from api.v1.schemas.currency import ExchangeRatesResponse, CurrencyPreferenceRequest; print('Schemas imported successfully')\"",
            "expected": "Schemas imported successfully"
          },
          "status": "completed",
          "notes": "Created src/api/v1/schemas/currency.py with all required Pydantic schemas: CurrencyCode enum, CurrencyPreferenceRequest, CurrencyConversionRequest, ExchangeRateItem, ExchangeRatesResponse, CurrencyPreferenceResponse, CurrencyConversionResponse, and SchedulerStatusResponse. All schemas follow existing patterns and include proper field validation.",
          "updated_at": "2025-12-31T22:13:27.505361+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Create currency API endpoints",
          "service": "backend",
          "files_to_modify": [
            "src/api/v1/__init__.py"
          ],
          "files_to_create": [
            "src/api/v1/endpoints/currency.py"
          ],
          "patterns_from": [
            "src/api/v1/endpoints/auth.py"
          ],
          "verification": {
            "type": "api",
            "method": "GET",
            "url": "http://localhost:8000/api/v1/currency/rates",
            "expected_status": 200
          },
          "status": "completed",
          "notes": "Created src/api/v1/endpoints/currency.py with all required endpoints: GET /currency/rates (get current exchange rates), POST /currency/refresh (manual rate refresh, auth required), POST /currency/convert (convert amounts between currencies), GET /currency/preference (get user preference, auth required), POST /currency/preference (set user preference, auth required), GET /currency/health (health check). Updated src/api/v1/router.py to include the currency router. All endpoints follow existing FastAPI patterns and use the ExchangeRateService and Pydantic schemas created in previous subtasks.",
          "updated_at": "2025-12-31T22:25:33.804958+00:00"
        }
      ]
    },
    {
      "id": "phase-5-frontend-state",
      "name": "Frontend Redux State",
      "type": "implementation",
      "description": "Create Redux slice for currency state management with localStorage persistence",
      "depends_on": [
        "phase-4-api-endpoints"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create currency Redux slice",
          "service": "frontend",
          "files_to_modify": [
            "web/src/store/index.js"
          ],
          "files_to_create": [
            "web/src/store/slices/currencySlice.js"
          ],
          "patterns_from": [
            "web/src/store/slices/authSlice.js"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'currencySlice' web/src/store/index.js && echo 'OK' || echo 'MISSING'",
            "expected": "OK"
          },
          "status": "pending",
          "notes": "Slice must include: selectedCurrency, exchangeRates, lastUpdated, loading, error. Actions: setCurrency (with localStorage), setExchangeRates, fetchExchangeRates (async thunk), fetchUserPreference (async thunk)"
        },
        {
          "id": "subtask-5-2",
          "description": "Create currency formatting utility",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [
            "web/src/utils/formatCurrency.js"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd web/src && node -e \"const {formatPrice} = require('./utils/formatCurrency.js'); console.log('OK')\" || echo 'OK'",
            "expected": "OK"
          },
          "status": "pending",
          "notes": "Use Dinero.js v2. Functions: formatPrice(amountInCents, currencyCode), convertPrice(baseAmountInCents, fromCurrency, toCurrency, exchangeRate). Must handle BRL definition if not in @dinero.js/currencies"
        }
      ]
    },
    {
      "id": "phase-6-frontend-components",
      "name": "Frontend Components",
      "type": "implementation",
      "description": "Create CurrencySelector component and update price displays",
      "depends_on": [
        "phase-5-frontend-state"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Create CurrencySelector dropdown component",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [
            "web/src/components/CurrencySelector.jsx"
          ],
          "patterns_from": [
            "web/src/components/"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:8000",
            "checks": [
              "CurrencySelector component renders",
              "Dropdown shows USD, EUR, GBP, BRL",
              "Selection updates Redux state"
            ]
          },
          "status": "pending",
          "notes": "Use Radix UI Select component. Show currency codes and symbols. Connected to Redux currencySlice. OnChange dispatches setCurrency action and calls backend /user/currency endpoint"
        },
        {
          "id": "subtask-6-2",
          "description": "Add CurrencySelector to navigation/header",
          "service": "frontend",
          "files_to_modify": [
            "web/src/components/Layout.jsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "web/src/components/Layout.jsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:8000",
            "checks": [
              "Currency selector visible in navigation",
              "Persists selection across page navigation"
            ]
          },
          "status": "pending",
          "notes": "Add CurrencySelector to main navigation bar or header. Should be accessible from all pages."
        },
        {
          "id": "subtask-6-3",
          "description": "Update price display components to use selected currency",
          "service": "frontend",
          "files_to_modify": [
            "web/src/components/dashboard/OfferCard.jsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "browser",
            "url": "http://localhost:8000",
            "checks": [
              "Prices display in selected currency",
              "Currency symbol correct (\u20ac, \u00a3, R$, $)",
              "Amounts match backend conversion"
            ]
          },
          "status": "pending",
          "notes": "Update OfferCard and any other components displaying prices. Use formatCurrency utility. Subscribe to Redux selectedCurrency and exchangeRates. Convert USD base price using exchange rate."
        }
      ]
    },
    {
      "id": "phase-7-integration",
      "name": "Integration & Verification",
      "type": "integration",
      "description": "Wire all services together, verify end-to-end functionality, and ensure graceful error handling",
      "depends_on": [
        "phase-3-scheduler",
        "phase-6-frontend-components"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "End-to-end currency selection and price conversion flow",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Start backend with scheduler running",
              "Verify scheduler fetched initial exchange rates",
              "Open frontend in browser",
              "Select EUR from currency dropdown",
              "Verify all prices update to EUR",
              "Check Redis for cached rates",
              "Check database for stored rates and user preference",
              "Reload page and verify EUR selection persists"
            ]
          },
          "status": "pending",
          "notes": "Full integration test. Verify: scheduler runs, rates cached in Redis, rates stored in DB, user preference saved, frontend fetches rates, prices convert correctly, localStorage persists selection"
        },
        {
          "id": "subtask-7-2",
          "description": "Test graceful fallback when exchange rate API fails",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Set invalid EXCHANGE_RATE_API_KEY to simulate API failure",
              "Trigger scheduler or rate fetch manually",
              "Verify system uses cached rates from Redis/DB",
              "Verify warning logged about stale rates",
              "Verify prices still display using cached rates",
              "Restore valid API key"
            ]
          },
          "status": "pending",
          "notes": "Test error handling. System must gracefully degrade to cached rates. Should log warnings but not crash. Frontend should still work with last known rates."
        },
        {
          "id": "subtask-7-3",
          "description": "Install Python and JavaScript dependencies",
          "all_services": true,
          "files_to_modify": [
            "requirements.txt",
            "web/package.json"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pip list | grep -E 'babel|apscheduler|httpx' && cd web && npm list dinero.js && echo 'All dependencies installed'",
            "expected": "All dependencies installed"
          },
          "status": "pending",
          "notes": "Backend: pip install babel apscheduler httpx. Frontend: cd web && npm install dinero.js @dinero.js/currencies"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 7,
    "total_subtasks": 16,
    "services_involved": [
      "backend (src/)",
      "frontend (web/)",
      "database (PostgreSQL)",
      "cache (Redis)"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-exchange-rate-service",
            "phase-4-api-endpoints"
          ],
          "reason": "Both depend only on phase-1-database-models and work on different files. Exchange rate service creates src/services/, API endpoints create src/api/v1/endpoints/. No file conflicts."
        },
        {
          "phases": [
            "phase-4-api-endpoints",
            "phase-5-frontend-state"
          ],
          "reason": "API endpoints (backend) and Redux state (frontend) are in different services and can be developed in parallel. Frontend will consume API once complete."
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.4x faster than sequential (some phases can run in parallel)"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 016 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "e2e"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "User can select currency from dropdown (USD, EUR, GBP, BRL)",
      "Currency preference persists across sessions (localStorage + backend)",
      "All prices display in selected currency",
      "Exchange rates update daily via scheduler",
      "Graceful fallback to cached rates on API failure",
      "No console errors or backend exceptions"
    ],
    "verification_steps": [
      {
        "name": "Backend Unit Tests",
        "command": "cd src && pytest tests/test_currency_models.py tests/test_exchange_rate_service.py -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "API Integration Tests",
        "command": "cd src && pytest tests/integration/test_currency_api.py -v",
        "expected_outcome": "Currency endpoints return correct data",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Frontend Component Tests",
        "command": "cd web && npm test -- CurrencySelector",
        "expected_outcome": "CurrencySelector component tests pass",
        "type": "test",
        "required": false,
        "blocking": false
      },
      {
        "name": "End-to-End Currency Flow",
        "command": "cd tests && npx playwright test currency-selection.spec.js",
        "expected_outcome": "User can select currency and see prices update",
        "type": "e2e",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk change requires comprehensive testing. New feature with backend API, scheduler, database changes, and frontend components. Unit tests for logic, integration tests for API, E2E for user flows."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd src && pytest tests/test_currency*.py"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "cd src && pytest tests/integration/test_currency_api.py"
      ],
      "services_to_test": [
        "backend",
        "database",
        "redis"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "cd tests && npx playwright test currency-selection.spec.js"
      ],
      "flows": [
        "currency-selection",
        "price-conversion",
        "preference-persistence"
      ]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:8000/",
          "checks": [
            "Currency selector visible in navigation",
            "Dropdown shows 4 currencies",
            "Prices display in selected currency"
          ]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "exchange_rates table exists with correct schema",
        "user_currency_preferences table exists",
        "Daily exchange rates populated (3 rows: USD\u2192EUR, USD\u2192GBP, USD\u2192BRL)"
      ]
    }
  },
  "qa_signoff": null,
  "last_updated": "2025-12-31T22:25:33.805209+00:00"
}